# BA-Agent (Business Analysis Agent)

**版本**: v2.3.0
**创建日期**: 2025-02-04
**最后更新**: 2026-02-08
**架构**: Single LangChain Agent + Pipeline v2.1 + Configurable Skills + ContextCoordinator
**开发进度**: ~88% (26/30 User Stories 完成)

---

## 项目概述

商业分析助手Agent，面向非技术业务人员，通过自然语言交互提供异动检测、归因分析、报告生成和数据可视化能力。

---

## 产品定位

### 目标用户
- **主要用户**: 运营、产品、市场等业务人员（非技术背景）
- **用户特征**: 不懂SQL/编程，日常需要查看数据、分析趋势、写报告
- **核心痛点**:
  - 问数据要等数据团队
  - 看到数据波动不知道原因
  - 写报告要手动收集数据
  - 数据分散在多个系统

### 核心价值主张
| 痛点 | 解决方案 |
|------|----------|
| 问数据要等数据团队 | 自然语言即时查询 |
| 看到数据波动不知道原因 | AI自动归因分析 |
| 写报告要手动收集数据 | 一键自动生成分析报告 |
| 数据分散在多个系统 | 统一入口查询所有数据 |

---

## 开发状态 (2026-02-08)

### 已完成 ✅
- **Phase 1**: Agent 框架 - LangGraph + Claude Sonnet 4.5
- **Phase 2**: 9 个核心工具
  - execute_command - Docker 隔离命令执行 (16 tests)
  - run_python - Docker 隔离 Python 执行 (29 tests)
  - web_search - Web 搜索 (MCP) (22 tests)
  - web_reader - Web 读取 (MCP) (27 tests)
  - file_reader - 多格式文件读取 (61 tests)
  - file_write - 通用文件写入 (14 tests)
  - query_database - SQL 查询 (54 tests)
  - search_knowledge - 向量检索 (51 tests)
  - invoke_skill - Skill 调用 (43 tests)
- **Phase 3**: Skills 配置系统 - 4 个内置 Skill 框架
- **Pipeline v2.1.0**: 完整的 Pipeline 系统实现
  - OutputLevel (BRIEF/STANDARD/FULL)
  - DynamicTokenCounter - 多模型 Token 计数
  - AdvancedContextManager - 智能上下文压缩
  - IdempotencyCache - 跨轮次缓存
  - ToolTimeoutHandler - 超时处理
  - DataStorage - Artifact 存储
  - 移除旧模型 - 清理 ResponseFormat/ToolOutput
- **核心 Skills**: 4 个 Skill 完整实现 (90 tests)
  - 异动检测 - 3 种检测方法 (23 tests)
  - 归因分析 - 3 种归因方法 (19 tests)
  - 报告生成 - 4 种报告类型 (19 tests)
  - 数据可视化 - 5 种图表类型 (29 tests)
- **API 服务**: FastAPI + JWT 认证 + 速率限制 (36 tests)
- **Web 前端**: 单页应用测试控制台
- **ContextCoordinator**: 统一上下文协调层 (24 tests)

### 待实现 ⏳
- **Phase 5**: IM Bot 集成 (钉钉/企业微信)
- **Phase 6**: Excel 插件 (Office.js)

### 测试状态
```
总计: 1030 个测试
✅ 通过: 1030 (100%)
⏭️  跳过: 1 (MCP 相关)
❌ 失败: 0
```

---

## MVP范围

### 核心功能
- ✅ 异动检测与解释（统计规则 + 历史对比 + 用户自定义 + AI智能）
- ✅ 归因分析（维度下钻 + 事件归因 + 外部因素 + 用户分群）
- ✅ 报告生成（日报/周报/月报自动生成）
- ✅ 数据可视化（图表自动生成与推荐）
- ✅ 混合数据源支持（数仓 + 业务库 + SaaS平台）

**注**: 核心功能框架已完成，业务逻辑在 Skills 中实现（待完成）

### 交付形态
- **当前**: Python API
- **规划中**: IM Bot (钉钉/企业微信/Slack)
- **规划中**: Excel 插件 - Office.js 侧边栏，结果直接写入表格

---

## 技术架构

### 架构设计原则
1. **单 Agent + Pipeline v2.1 + 可配置 Skills**
   - 一个主 Agent (LangGraph)
   - Pipeline v2.1: 统一工具输出格式 (ToolExecutionResult)
   - 基础工具：execute_command, run_python, web_search, web_reader, file_reader, file_write, query_database, search_knowledge
   - Skills 通过配置注册，可动态扩展

2. **Agent Loop 迭代**
   - 每次循环：Analyze → Plan → Execute → Observe
   - 持续迭代直到任务完成

3. **Python 沙盒是核心**
   - 所有分析能力通过 Python + Claude Skill 实现
   - 本地 Docker 隔离环境替代云端虚拟机

4. **Skills 可配置**
   - 用户可以添加自定义 Skills
   - Skills 通过 YAML 配置文件注册
   - Agent 通过 `invoke_skill` 工具调用

5. **Pipeline v2.1.0 特性**
   - **OutputLevel**: BRIEF/STANDARD/FULL 三级输出控制
   - **ToolCachePolicy**: 缓存策略管理
   - **DynamicTokenCounter**: 精确的 Token 计数
   - **AdvancedContextManager**: 智能上下文压缩
   - **IdempotencyCache**: 跨轮次语义缓存
   - **ToolTimeoutHandler**: 同步超时控制

6. **ContextCoordinator 协调层 (v2.3.0 新增)**
   - 统一的上下文准备入口
   - 协调文件清理和上下文构建
   - 确保系统提示在第一位
   - 明确职责划分（LangGraph 管理历史，ContextManager 管理清理）

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Python API  │  │  IM Bot      │  │  Excel插件   │  │  Web API     │    │
│  │  (当前可用)  │  │  (规划中)    │  │  (规划中)    │  │  (当前可用)  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       API 服务层 (FastAPI)                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  JWT 认证 | 速率限制 | 错误处理 | 请求日志                              │   │
│  │  BAAgentService (HTTP 接口包装、对话管理)                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    上下文协调层 (ContextCoordinator)                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • prepare_messages() - 准备发送给 LLM 的消息列表                       │   │
│  │  • 协调文件清理和上下文构建                                              │   │
│  │  • 确保系统提示在第一位                                                  │   │
│  │  • 委托文件清理给 ContextManager                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                  ┌─────────────────────┼─────────────────────┐
                  ▼                     ▼                     ▼
┌─────────────────────────────┐ ┌─────────────────────┐ ┌──────────────────────┐
│   Pipeline v2.1.0           │ │   ContextManager     │ │   LangGraph         │
│  (输出管理层)               │ │   (上下文管理)        │ │   (状态管理)        │
│  ┌──────────────────────┐   │ │  ┌────────────────┐  │ │  ┌────────────────┐  │
│  │ ToolExecutionResult │   │ │  │ clean_langchain │  │ │  │ AgentState     │  │
│  │ OutputLevel         │   │ │  │ _build_context  │  │ │  │ Checkpointer   │  │
│  │ TokenCounter        │   │ │  │ _code_list      │  │ │  │ 消息追加       │  │
│  └──────────────────────┘   │ │  └────────────────┘  │ │  └────────────────┘  │
└─────────────────────────────┘ └─────────────────────┘ └──────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Agent Loop (LangGraph)                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  Analyze → Plan → Execute → Observe                │   │
│  │                  (ReAct Pattern with MemorySaver)                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        基础工具层 (v2.1)                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ execute_cmd  │  │ run_python   │  │ web_search   │          │   │
│  │  │(Docker隔离) │  │(Docker隔离) │  │  (MCP Z.ai)  │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ web_reader   │  │ file_reader  │  │ file_write   │          │   │
│  │  │  (MCP Z.ai)  │  │(多格式支持)  │  │(三种模式)    │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐                              │   │
│  │  │ query_db     │  │ search_kb    │                              │   │
│  │  │(SQLAlchemy)  │  │(Chroma/内存) │                              │   │
│  │  └──────────────┘  └──────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Skills 层 (可配置)                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  skills/                                                          │   │
│  │  ├── anomaly_detection/SKILL.md    (异动检测 - 框架完成)          │   │
│  │  ├── attribution/SKILL.md         (归因分析 - 框架完成)          │   │
│  │  ├── report_gen/SKILL.md          (报告生成 - 框架完成)          │   │
│  │  ├── visualization/SKILL.md       (数据可视化 - 框架完成)        │   │
│  │  └── [用户自定义 Skills...]                                       │   │
│  │                                                                 │   │
│  │  config/skills.yaml (Skill 注册配置)                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据与记忆层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  业务数据库   │  │  数据仓库     │  │  SaaS API    │  │  向量数据库   │   │
│  │  (PostgreSQL) │  │ (ClickHouse)  │  │ (第三方接口)  │  │  (Chroma)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    三层记忆系统                                  │   │
│  │  Layer 1: memory/YYYY-MM-DD.md (每日对话日志)                   │   │
│  │  Layer 2: MEMORY.md (长期知识记忆)                              │   │
│  │  Layer 3: CLAUDE.md (项目级记忆)                               │   │
│  │  MemoryFlush (自动提取) + MemoryWatcher (文件监听)              │   │
│  │  MemorySearch (FTS5 + 向量混合搜索)                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **API框架** | FastAPI (规划中) | 高性能、异步支持、自动文档 |
| **Agent框架** | LangGraph | ReAct Agent、MemorySaver |
| **LLM** | Claude 3.5 Sonnet | 中文理解强、长上下文、性价比高 |
| **Pipeline** | Pipeline v2.1.0 | 自研统一工具输出格式系统 |
| **向量数据库** | ChromaDB | 轻量级、易部署、支持本地运行 |
| **关系数据库** | PostgreSQL | 成熟可靠、支持JSON |
| **全文搜索** | SQLite FTS5 | 本地索引、BM25 算法 |
| **消息队列** | Redis (规划中) | 简化版，用于任务队列 |
| **容器隔离** | Docker | 本地隔离环境替代云端虚拟机 |
| **MCP 集成** | Z.ai (智谱) | Web 搜索 + Web 读取 |
| **备用 LLM** | Gemini 1.5 Flash | LingYi AI 代理支持 |

---

## 核心功能设计

### 1. 异动检测与解释
**用户场景**: "今天GMV有什么异常？"
**功能描述**:
- 自动检测：系统定期扫描关键指标，发现异常自动推送
- 查询触发：用户主动询问，系统返回近期异动
- 多维度检测：统计规则（3-sigma）、历史对比（同比/环比）、用户自定义阈值
- 智能解释：AI分析可能原因，给出初步结论

### 2. 归因分析
**用户场景**: "为什么本周GMV增长了？"
**功能描述**:
- 维度下钻：自动分析各维度的贡献度
- 事件归因：关联营销活动、功能发布等事件
- 外部因素：考虑节假日、天气、竞品动作等
- 用户分群：分析新老用户、不同群体的行为差异

### 3. 报告生成
**用户场景**: "帮我生成本周业务周报"
**功能描述**:
- 周期报告：支持日报、周报、月报
- 模板化：提供多种报告模板
- 智能洞察：自动提取关键指标变化、异常、趋势
- 多格式导出：支持PDF、Word、Excel

### 4. 数据可视化
**用户场景**: "把最近30天的GMV趋势用图表展示"
**功能描述**:
- 智能图表推荐：根据数据类型自动推荐
- 自然语言生成："给我看各地区GMV占比的饼图"
- 交互式图表：支持缩放、筛选、下钻
- 导出分享：图表可导出为图片或嵌入报告

---

## Agent + 工具 + Skills 协作流程

```
用户: "今天GMV有什么异常？"
    │
    ▼
┌─────────────────────────────────────────┐
│  Agent Loop 开始                         │
│  ┌─────────────────────────────────┐   │
│  │ 1. Analyze: 理解用户意图             │   │
│  │    → 意图：异动检测查询             │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 2. Plan: 制定执行计划             │   │
│  │    → 工具：query_database,        │   │
│  │            invoke_skill           │   │
│  │    → 步骤：1.查GMV数据            │   │
│  │            2.调用异动检测skill    │   │
│  │            3.返回结果              │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 3. Execute: 执行计划             │   │
│  │    → query_database("GMV最近7天") │   │
│  │    → invoke_skill("anomaly_       │   │
│  │       detection", data)          │   │
│  │    → (内部: run_python调用         │   │
│  │       异动检测Skill代码)          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 4. Observe: 观察结果               │   │
│  │    → 任务完成？返回结果            │   │
│  │    → 未完成？继续下一轮            │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## Skills 配置系统

### config/skills.yaml 格式

```yaml
skills:
  anomaly_detection:
    name: 异动检测分析
    description: 检测数据中的异常波动并分析原因
    entrypoint: skills/anomaly_detection/main.py
    function: detect
    requirements:
      - pandas
      - numpy
      - scipy
      - anthropic
    config:
      default_method: statistical
      methods:
        - statistical   # 3-sigma
        - historical    # 同比/环比
        - ai           # AI智能识别
      threshold: 2.0

  attribution:
    name: 归因分析
    description: 分析指标变化的归因因素
    entrypoint: skills/attribution/main.py
    function: analyze
    config:
      dimensions:
        - region      # 地区
        - category    # 品类
        - channel     # 渠道
        - user_segment # 用户分群

  report_gen:
    name: 报告生成
    description: 自动生成业务分析报告
    entrypoint: skills/report_gen/main.py
    function: generate
    config:
      templates:
        - daily
        - weekly
        - monthly
      formats:
        - pdf
        - docx
        - xlsx

  visualization:
    name: 数据可视化
    description: 生成数据可视化图表
    entrypoint: skills/visualization/main.py
    function: create_chart
    config:
      chart_types:
        - line
        - bar
        - pie
        - heatmap
        - map
```

---

## 成功指标

### 产品指标
| 指标 | 目标 | 当前状态 |
|------|------|----------|
| 日活跃用户 | MVP上线后1个月内达到100+ | - |
| 查询成功率 | >90% | ✅ 测试覆盖率 100% |
| 平均响应时间 | <5秒 | ✅ 本地测试 <2s |
| 用户满意度 | >4.0/5.0 | - |

### 业务指标
| 指标 | 目标 | 当前状态 |
|------|------|----------|
| 节省时间 | 相比传统方式节省70%时间 | - |
| 数据洞察准确率 | >85% | - |
| 报告生成效率 | 从小时级到分钟级 | - |

---

## 后续规划

### 当前阶段 (2026-02-06)
- ✅ Pipeline v2.1.0 完成
- ✅ Phase 7: 移除旧模型完成
- ⏳ 实现 4 个 Skill 的核心业务逻辑
- ⏳ FastAPI 服务开发

### Phase 4: API 服务 (2026 Q2)
- FastAPI 服务实现
- API 文档自动生成
- 请求/响应日志
- 错误处理和监控
- 性能优化

### Phase 5: IM Bot 集成 (2026 Q2)
- 企业微信 Bot 集成
- 钉钉 Bot 集成
- 消息格式适配
- 对话状态管理

### Phase 6: Excel 插件 (2026 Q3)
- Office.js 侧边栏
- 结果直接写入表格
- 图表自动生成
- 模板库

### Phase 7: 高级功能 (2026 Q3-Q4)
- 预测分析功能
- 更多图表类型
- 自定义仪表盘
- 移动端支持
- 多租户支持
- 更多数据源连接器
- 行业模板库
- API 开放平台

---

## 测试覆盖

### 测试统计 (2026-02-06)
```
总计: 746 个测试
✅ 通过: 746 (100%)
⏭️  跳过: 1 (MCP 相关)
❌ 失败: 0
```

### 测试分类
| 类别 | 测试数 | 状态 |
|------|--------|------|
| 基础设施 | 135 | ✅ |
| 核心工具 | 303 | ✅ |
| Skills 系统 | 137 | ✅ |
| Pipeline v2.1 | 42 | ✅ |
| Memory 系统 | 120 | ✅ |
| Agent 集成 | 100 | ✅ |
| MCP 集成 | 9 | ✅ |

---

**文档版本**: v2.1.0
**最后更新**: 2026-02-06
**维护者**: BA-Agent Team
**测试状态**: 746/746 通过 (100%)
