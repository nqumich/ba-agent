# BA-Agent (Business Analysis Agent)

**版本**: v1.0
**创建日期**: 2025-02-04
**架构**: Single LangChain Agent + Basic Tools + Configurable Skills

---

## 项目概述

商业分析助手Agent，面向非技术业务人员，通过自然语言交互提供异动检测、归因分析、报告生成和数据可视化能力。

---

## 产品定位

### 目标用户
- **主要用户**: 运营、产品、市场等业务人员（非技术背景）
- **用户特征**: 不懂SQL/编程，日常需要查看数据、分析趋势、写报告
- **核心痛点**:
  - 问数据要等数据团队
  - 看到数据波动不知道原因
  - 写报告要手动收集数据
  - 数据分散在多个系统

### 核心价值主张
| 痛点 | 解决方案 |
|------|----------|
| 问数据要等数据团队 | 自然语言即时查询 |
| 看到数据波动不知道原因 | AI自动归因分析 |
| 写报告要手动收集数据 | 一键自动生成分析报告 |
| 数据分散在多个系统 | 统一入口查询所有数据 |

---

## MVP范围

### 核心功能
- ✅ 异动检测与解释（统计规则 + 历史对比 + 用户自定义 + AI智能）
- ✅ 归因分析（维度下钻 + 事件归因 + 外部因素 + 用户分群）
- ✅ 报告生成（日报/周报/月报自动生成）
- ✅ 数据可视化（图表自动生成与推荐）
- ✅ 混合数据源支持（数仓 + 业务库 + SaaS平台）

### 交付形态
- **IM Bot**: 集成到企业通讯工具（钉钉/企业微信/Slack）
- **Excel插件**: Office.js侧边栏，结果直接写入表格

---

## 技术架构

### 架构设计原则
1. **单Agent + 基础工具 + 可配置Skills**
   - 一个主Agent (LangChain)
   - 基础工具：execute_command, run_python, web_search, read_webpage, read_file, query_database, search_knowledge
   - Skills通过配置注册，可动态扩展

2. **Agent Loop迭代**
   - 每次循环：Analyze → Plan → Execute → Observe
   - 持续迭代直到任务完成

3. **Python沙盒是核心**
   - 所有分析能力通过Python + Claude Skill实现
   - 本地Docker隔离环境替代云端虚拟机

4. **Skills可配置**
   - 用户可以添加自定义Skills
   - Skills通过YAML配置文件注册
   - Agent通过`invoke_skill`工具调用

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  IM Bot      │  │  Excel插件   │  │  Web控制台   │  │  API        │    │
│  │  (钉钉/企微)  │  │  (Office.js)  │  │  (管理后台)  │  │  (REST)     │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Agent Loop (迭代循环)                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  Analyze → Plan → Execute → Observe                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        基础工具层                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ 命令行工具    │  │ Python沙盒   │  │ Web搜索      │          │   │
│  │  │(Docker隔离) │  │(Docker隔离) │  │(搜索API)    │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ Web Reader   │  │ 文件读取     │  │ SQL查询      │          │   │
│  │  │(内容提取)    │  │(多格式支持)  │  │(SQLAlchemy)  │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐                              │   │
│  │  │ 向量检索     │  │ Skill调用    │                              │   │
│  │  │(知识检索)    │  │(桥接Skills)  │                              │   │
│  │  └──────────────┘  └──────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        可配置Skills层                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  skills/                                                          │   │
│  │  ├── anomaly_detection/SKILL.md    (异动检测分析)                  │   │
│  │  ├── attribution/SKILL.md         (归因分析)                      │   │
│  │  ├── report_gen/SKILL.md          (报告生成)                      │   │
│  │  ├── visualization/SKILL.md       (数据可视化)                    │   │
│  │  └── [用户自定义Skills...]                                           │   │
│  │                                                                 │   │
│  │  config/skills.yaml (Skill注册配置)                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据与知识层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  业务数据库   │  │  数据仓库     │  │  SaaS API    │  │  向量数据库   │   │
│  │  (MySQL/PG)   │  │ (ClickHouse)  │  │ (第三方接口)  │  │  (Chroma)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                                     │
│  │  指标知识库   │  │  分析模板库   │                                     │
│  │  (YAML/JSON)  │  │  (报告模板)   │                                     │
│  └──────────────┘  └──────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **API框架** | FastAPI | 高性能、异步支持、自动文档 |
| **Agent框架** | LangChain | 成熟的工具生态、丰富的集成 |
| **LLM** | Claude 3.5 Sonnet | 中文理解强、长上下文、性价比高 |
| **向量数据库** | Chroma | 轻量级、易部署、支持本地运行 |
| **关系数据库** | PostgreSQL | 成熟可靠、支持JSON |
| **消息队列** | Redis | 简化版，用于任务队列 |
| **容器隔离** | Docker | 本地隔离环境替代云端虚拟机 |

---

## 核心功能设计

### 1. 异动检测与解释
**用户场景**: "今天GMV有什么异常？"
**功能描述**:
- 自动检测：系统定期扫描关键指标，发现异常自动推送
- 查询触发：用户主动询问，系统返回近期异动
- 多维度检测：统计规则（3-sigma）、历史对比（同比/环比）、用户自定义阈值
- 智能解释：AI分析可能原因，给出初步结论

### 2. 归因分析
**用户场景**: "为什么本周GMV增长了？"
**功能描述**:
- 维度下钻：自动分析各维度的贡献度
- 事件归因：关联营销活动、功能发布等事件
- 外部因素：考虑节假日、天气、竞品动作等
- 用户分群：分析新老用户、不同群体的行为差异

### 3. 报告生成
**用户场景**: "帮我生成本周业务周报"
**功能描述**:
- 周期报告：支持日报、周报、月报
- 模板化：提供多种报告模板
- 智能洞察：自动提取关键指标变化、异常、趋势
- 多格式导出：支持PDF、Word、Excel

### 4. 数据可视化
**用户场景**: "把最近30天的GMV趋势用图表展示"
**功能描述**:
- 智能图表推荐：根据数据类型自动推荐
- 自然语言生成："给我看各地区GMV占比的饼图"
- 交互式图表：支持缩放、筛选、下钻
- 导出分享：图表可导出为图片或嵌入报告

---

## Agent + 工具 + Skills 协作流程

```
用户: "今天GMV有什么异常？"
    │
    ▼
┌─────────────────────────────────────────┐
│  Agent Loop 开始                         │
│  ┌─────────────────────────────────┐   │
│  │ 1. Analyze: 理解用户意图             │   │
│  │    → 意图：异动检测查询             │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 2. Plan: 制定执行计划             │   │
│  │    → 工具：query_database,        │   │
│  │            invoke_skill           │   │
│  │    → 步骤：1.查GMV数据            │   │
│  │            2.调用异动检测skill    │   │
│  │            3.返回结果              │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 3. Execute: 执行计划             │   │
│  │    → query_database("GMV最近7天") │   │
│  │    → invoke_skill("anomaly_       │   │
│  │       detection", data)          │   │
│  │    → (内部: run_python调用         │   │
│  │       异动检测Skill代码)          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 4. Observe: 观察结果               │   │
│  │    → 任务完成？返回结果            │   │
│  │    → 未完成？继续下一轮            │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## Skills 配置系统

### config/skills.yaml 格式

```yaml
skills:
  anomaly_detection:
    name: 异动检测分析
    description: 检测数据中的异常波动并分析原因
    entrypoint: skills/anomaly_detection/main.py
    function: detect
    requirements:
      - pandas
      - numpy
      - scipy
      - anthropic
    config:
      default_method: statistical
      methods:
        - statistical   # 3-sigma
        - historical    # 同比/环比
        - ai           # AI智能识别
      threshold: 2.0

  attribution:
    name: 归因分析
    description: 分析指标变化的归因因素
    entrypoint: skills/attribution/main.py
    function: analyze
    config:
      dimensions:
        - region      # 地区
        - category    # 品类
        - channel     # 渠道
        - user_segment # 用户分群

  report_gen:
    name: 报告生成
    description: 自动生成业务分析报告
    entrypoint: skills/report_gen/main.py
    function: generate
    config:
      templates:
        - daily
        - weekly
        - monthly
      formats:
        - pdf
        - docx
        - xlsx

  visualization:
    name: 数据可视化
    description: 生成数据可视化图表
    entrypoint: skills/visualization/main.py
    function: create_chart
    config:
      chart_types:
        - line
        - bar
        - pie
        - heatmap
        - map
```

---

## 成功指标

### 产品指标
| 指标 | 目标 |
|------|------|
| 日活跃用户 | MVP上线后1个月内达到100+ |
| 查询成功率 | >90% |
| 平均响应时间 | <5秒 |
| 用户满意度 | >4.0/5.0 |

### 业务指标
| 指标 | 目标 |
|------|------|
| 节省时间 | 相比传统方式节省70%时间 |
| 数据洞察准确率 | >85% |
| 报告生成效率 | 从小时级到分钟级 |

---

## 后续规划

### Phase 2
- 预测分析功能
- 更多图表类型
- 自定义仪表盘
- 移动端支持

### Phase 3
- 多租户支持
- 更多数据源连接器
- 行业模板库
- API开放平台
