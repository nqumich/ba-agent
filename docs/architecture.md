# BA-Agent 产品设计与技术架构

> **版本**: v2.1.0
> **最后更新**: 2026-02-07
> **状态**: Beta (框架完成，核心功能开发中)
> **开发进度**: ~70% (19/27 用户故事完成)

---

## 📋 文档概述

本文档是 BA-Agent 的核心设计文档，从产品愿景、用户需求到技术架构、系统设计的完整描述。

---

## 🎯 产品愿景

> **让每一位业务人员都能像拥有数据分析师一样，通过自然语言对话获得数据洞察**

**核心理念**: 不懂SQL、不会编程也能做数据分析

---

## 👥 目标用户

### 主要用户画像

| 用户类型 | 典型角色 | 核心痛点 | 使用场景 |
|----------|----------|----------|----------|
| **运营人员** | 电商运营、用户运营 | • 问数据要等数据团队<br>• 看到GMV波动不知道原因<br>• 写日报周报要手动查数 | • 每天查看GMV、转化率<br>• 分析活动效果<br>• 生成运营报告 |
| **产品经理** | B端/C端产品经理 | • 数据分散在多个系统<br>• 分析问题需要跑数<br>• 需要定期做产品复盘 | • 分析功能使用数据<br>• 评估A/B测试结果<br>• 生成产品报告 |
| **市场人员** | 市场推广、品牌 | • 广告ROI分析依赖数据团队<br>• 渠道效果对比耗时<br>• 预算分配缺乏数据支撑 | • 分析广告投放效果<br>• 对比各渠道ROI<br>• 优化投放策略 |
| **管理层** | 业务负责人、部门主管 | • 需要快速了解业务状况<br>• 深度分析需要专门安排<br>• 报告汇总耗时 | • 快速了解业务概况<br>• 查看异常指标<br>• 获取分析报告 |

---

## 💡 核心价值

### 用户问题 vs 产品解决方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户痛点                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ ❌ "今天GMV怎么降了？我要等数据团队跑数，可能明天才能有结果"                │
│ ❌ "为什么转化率突然下降？我需要拉数据、做报表、找原因...半天就过去了"      │
│ ❌ "每周五都要写周报，手动查数、做图表、写分析，至少花2小时"                │
│ ❌ "数据在数仓、在业务库、在第三方平台，到处都要登进去看"                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                            BA-Agent 解决方案                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ ✅ "今天GMV有什么异常？" → 即时返回分析结果，AI自动解释原因                 │
│ ✅ "为什么转化率降了？" → 自动归因分析，定位问题维度和可能原因               │
│ ✅ "帮我生成本周周报" → 一键生成完整报告，包含数据、图表、洞察              │
│ ✅ "查一下最近的广告ROI" → 统一入口查询所有数据源                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 核心价值主张

| 价值维度 | 传统方式 | 使用 BA-Agent | 提升效果 |
|----------|----------|---------------|----------|
| **响应速度** | 等待数据团队 (小时-天) | 即时响应 (秒级) | **100倍+** |
| **分析门槛** | 需要SQL/编程技能 | 自然语言对话 | **零门槛** |
| **报告效率** | 手动收集+分析 (2-4小时) | 一键生成 (分钟级) | **20倍+** |
| **数据获取** | 多系统登录切换 | 统一对话入口 | **10倍+** |

---

## 🚀 核心功能

### 功能全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BA-Agent 核心功能                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│  │ 异动检测    │   │ 归因分析    │   │ 报告生成    │   │ 数据可视化  │    │
│  │             │   │             │   │             │   │             │    │
│  │ "今天GMV    │   │ "为什么     │   │ "帮我生成   │   │ "把最近30天 │    │
│  │  有什么     │   │  本周GMV    │   │  本周业务   │   │  的GMV趋势  │    │
│  │  异常？"    │   │  增长了？"  │   │  周报"      │   │  用图表展示" │    │
│  └─────────────┘   └─────────────┘   └─────────────�   └─────────────┘    │
│         ↓                  ↓                  ↓                  ↓          │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         统一数据访问                                    │ │
│  │  • 数据仓库 (ClickHouse)  • 业务库 (PostgreSQL)  • SaaS平台 API        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 功能详情

#### 1️⃣ 异动检测

**用户场景**
```
用户: "今天GMV有什么异常？"

BA-Agent:
【异动检测结果】
• 检测时间: 2026-02-06 09:30
• 当前GMV: ¥823,456
• 环比: ▼15.3%
• 异常等级: ⚠️ 中等

【AI智能分析】
可能原因:
1. 昨日为促销活动最后一天，部分用户提前下单
2. 某核心品类缺货率上升
3. 竞品今日开始大促活动

建议: 可进一步查看品类维度数据和用户行为数据
```

**核心能力**
- ✅ 自动扫描: 系统定期监控关键指标，发现异常自动推送
- ✅ 多维度检测: 统计规则(3σ)、历史对比(同比/环比)、自定义阈值
- ✅ 智能解释: AI分析可能原因并给出建议
- ✅ 支持指标: GMV、订单量、转化率、客单价、ROI等

---

#### 2️⃣ 归因分析

**用户场景**
```
用户: "为什么本周GMV增长了20%？"

BA-Agent:
【归因分析结果】
增长贡献分解:

┌──────────────────────────────────────┐
│ 地区维度贡献                          │
│  华东: +35%  ████████████░░░░  │
│  华南: +15%  ██████░░░░░░░░░░  │
│  华北: +8%   ███░░░░░░░░░░░░░░  │
│  西部: +5%   ██░░░░░░░░░░░░░░░  │
└──────────────────────────────────────┘

【关键事件】
• 2月3日: 开启"新春大促"活动
• 2月1日: 上线新用户引导流程

【用户分群】
• 新用户贡献: +12%
• 老用户贡献: +8%

【结论】
主要归因: 新春大促活动(华东地区效果最佳)
次要归因: 新用户引导流程优化
```

**核心能力**
- ✅ 维度下钻: 自动分析各维度(地区/品类/渠道/用户)的贡献
- ✅ 事件归因: 关联营销活动、功能发布等事件
- ✅ 外部因素: 考虑节假日、竞品动作等
- ✅ 用户分群: 分析不同群体的行为差异

---

#### 3️⃣ 报告生成

**用户场景**
```
用户: "帮我生成本周的业务周报"

BA-Agent:
【已生成周报】📄

📊 本周业务概览 (2月1日-2月7日)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• GMV: ¥5,234,567  (环比 ▲12.3%)
• 订单量: 12,345单  (环比 ▲8.7%)
• 转化率: 3.2%      (环比 ▼0.3pp)
• 客单价: ¥424      (环比 ▲3.3%)

📈 关键趋势
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 周三达到周峰值 (GMV ¥892,345)
• 新用户占比提升至28%
• 移动端占比达76%

⚠️ 异常提醒
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 周四转化率异常下降 (2.1% → 2.6%)
• 某品类缺货率上升

💡 AI洞察建议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 建议补充XX品类库存
• 可针对周四时段做专项分析

[下载完整报告] [分享]
```

**核心能力**
- ✅ 多种周期: 日报、周报、月报
- ✅ 智能洞察: 自动提取关键变化、异常、趋势
- ✅ 多格式导出: PDF、Word、Excel
- ✅ 模板化: 提供多种报告模板

---

#### 4️⃣ 数据可视化

**用户场景**
```
用户: "把最近30天的GMV趋势用折线图展示"
用户: "给我看各地区GMV占比的饼图"
用户: "对比一下各渠道的转化率，用柱状图"

BA-Agent: [生成对应图表，支持交互式查看]
```

**核心能力**
- ✅ 自然语言生成: 直接用语言描述想要的图表
- ✅ 智能推荐: 根据数据类型推荐最佳图表
- ✅ 交互式图表: 支持缩放、筛选、下钻
- ✅ 图表类型: 折线、柱状、饼图、热力图、地图等

---

## 🏗️ 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Python API  │  │  IM Bot      │  │  Excel插件   │  │  Web API     │    │
│  │  (当前可用)  │  │  (规划中)    │  │  (规划中)    │  │  (规划中)    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Pipeline v2.1.0 (输出管理层)                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ToolExecutionResult | OutputLevel | CachePolicy | TokenCounter  │   │
│  │  ContextManager | IdempotencyCache | TimeoutHandler | Storage    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Agent Loop (自定义 LangGraph)                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                   自定义图结构 + 结构化响应格式                              │   │
│  │                                                                              │   │
│  │  ┌─────────┐     ┌──────────────┐     ┌─────────────┐                      │   │
│  │  │  agent  │────▶│should_continue │────▶│   tools/    │                      │   │
│  │  │  (LLM)  │     │  (条件判断)    │     │  (执行工具)  │                      │   │
│  │  └─────────┘     └──────────────┘     └─────────────┘                      │   │
│  │       │                                     │                               │   │
│  │       ▼                                     ▼                               │   │
│  │  ┌─────────────────────────────────────────────────────┐              │   │
│  │  │  type="tool_call" → convert_to_tool_call → tools    │              │   │
│  │  │  type="complete" → END (返回结构化响应)              │              │   │
│  │  └─────────────────────────────────────────────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  **结构化响应格式**:                                                            │
│  ```json                                                                        │
│  {                                                                            │
│    "task_analysis": "思维链分析",                                              │
│    "execution_plan": "R1: xxx; R2: xxx",                                     │
│    "current_round": 1,                                                        │
│    "action": {                                                                │
│      "type": "tool_call | complete",                                         │
│      "content": "...",                                                       │
│      "recommended_questions": ["..."],                                       │
│      "download_links": ["..."]                                               │
│    }                                                                          │
│  }                                                                            │
│  ```                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        工具层 (LangChain StructuredTools)                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │execute_cmd  │  │run_python   │  │web_search   │          │   │
│  │  │(Docker隔离) │  │(Docker隔离) │  │ (MCP Z.ai)  │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │web_reader   │  │file_reader  │  │file_write   │          │   │
│  │  │(MCP Z.ai)  │  │(多格式支持)  │  │(三种模式)    │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │  ┌──────────────┐  ┌──────────────┐                              │   │
│  │  │query_db     │  │search_kb    │                              │   │
│  │  │(SQLAlchemy)  │  │(Chroma/内存) │                              │   │
│  │  └──────────────┘  └──────────────┘                              │   │
│  │  ┌──────────────────────────────────────────────────────┐          │   │
│  │  │       memory_search_v2 (混合搜索 - Clawdbot 风格)       │          │   │
│  │  └──────────────────────────────────────────────────────┘          │   │
│  │  ┌──────────────────────────────────────────────────────┐          │   │
│  │  │       activate_skill (Skill 调用)                       │          │   │
│  │  └──────────────────────────────────────────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Skills 层 (可配置)                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  skills/                                                          │ │
│  │  ├── anomaly_detection/SKILL.md    (异动检测 - 框架完成)          │ │
│  │  ├── attribution/SKILL.md         (归因分析 - 框架完成)          │ │
│  │  ├── report_gen/SKILL.md          (报告生成 - 框架完成)          │ │
│  │  └── visualization/SKILL.md       (数据可视化 - 框架完成)        │ │
│  │                                                                 │ │
│  │  config/skills.yaml (Skill 注册配置)                             │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据与记忆层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  业务数据库   │  │  数据仓库     │  │  SaaS API    │  │  向量数据库   │   │
│  │ (PostgreSQL) │  │ (ClickHouse)  │  │ (第三方接口)  │  │  (Chroma)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                    三层记忆系统                                  │ │
│  │  Layer 1: memory/YYYY-MM-DD.md (每日对话日志)                   │ │
│  │  Layer 2: MEMORY.md (长期知识记忆)                              │ │
│  │  Layer 3: CLAUDE.md (项目级记忆)                               │ │
│  │  MemoryFlush (自动提取) + MemoryWatcher (后台监控)              │ │
│  │  MemorySearch (FTS5 + 向量混合搜索)                             │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🗂️ 目录结构与组件

### 核心目录

```
ba-agent/
├── backend/                     # 后端核心模块
│   ├── agents/                  # Agent 实现 (langchain.agents.create_agent)
│   ├── memory/                  # 三层记忆系统
│   │   ├── flush.py             # MemoryFlush - 自动记忆提取
│   │   ├── index.py             # MemoryWatcher - 文件监听和索引
│   │   ├── search.py            # MemorySearch - 混合搜索
│   │   └── tools/               # Memory 工具（系统内部）
│   ├── pipeline/                 # Pipeline v2.1.0
│   │   ├── timeout/            # ToolTimeoutHandler
│   │   ├── storage/            # DataStorage - Artifact 存储
│   │   ├── cache/              # IdempotencyCache
│   │   ├── token/              # DynamicTokenCounter
│   │   ├── context/            # AdvancedContextManager
│   │   └── wrapper.py          # PipelineToolWrapper
│   ├── models/                  # 数据模型
│   │   ├── agent.py             # Agent 相关模型
│   │   ├── pipeline/           # Pipeline 模型 (v2.1.0)
│   │   │   ├── output_level.py  # OutputLevel (BRIEF/STANDARD/FULL)
│   │   │   ├── tool_result.py   # ToolExecutionResult
│   │   │   ├── cache_policy.py  # ToolCachePolicy
│   │   │   └── tool_request.py  # ToolInvocationRequest
│   │   └── ...
│   ├── docker/                  # Docker 沙盒
│   ├── skills/                  # Skills 系统
│   │   ├── __init__.py         # Skills 包
│   │   ├── loader.py            # Skill 加载器
│   │   ├── registry.py          # Skill 注册表
│   │   ├── activator.py         # Skill 激活器
│   │   └── formatter.py         # 消息格式化
│   └── filestore/                # 文件系统 (新增)
│       ├── base.py              # BaseStore 接口
│       ├── file_store.py        # FileStore 主类
│       ├── file_ref.py          # FileRef 模型
│       ├── stores/              # 各类存储实现
│       └── checkpoint.py        # 中间结果捕获
│
├── tools/                        # LangChain 工具
│   ├── execute_command.py       # 命令行执行 (Docker)
│   ├── python_sandbox.py        # Python 执行 (Docker)
│   ├── web_search.py            # Web 搜索 (MCP)
│   ├── web_reader.py            # Web 读取 (MCP)
│   ├── file_reader.py           # 文件读取 (CSV/Excel/JSON等)
│   ├── file_write.py            # 文件写入
│   ├── database.py              # SQL 查询
│   ├── vector_search.py         # 向量检索
│   └── skill_invoker.py         # Skill 调用
│
├── skills/                       # Skills 实现
│   ├── anomaly_detection/        # 异动检测
│   ├── attribution/             # 归因分析
│   ├── report_gen/              # 报告生成
│   └── visualization/          # 数据可视化
│
├── config/                      # 配置管理
│   ├── config.py                # 配置管理器
│   ├── settings.yaml            # 主配置文件
│   ├── skills.yaml              # Skills 配置
│   └── filestore.yaml           # 文件系统配置 (新增)
│
├── tests/                       # 测试套件 (746 个测试)
│   ├── test_filestore/          # 文件系统测试 (新增)
│   ├── test_agents/             # Agent 测试
│   ├── test_tools/              # 工具测试
│   ├── test_skills/             # Skills 测试
│   ├── backend/                 # 后端测试
│   └── ...
│
├── memory/                      # Layer 1: 每日对话日志
│   ├── 2026-02-06.md
│   └── ...
│
├── docs/                        # 设计文档
│   ├── architecture.md          # 本文档
│   └── implementation.md       # 执行计划
│
├── AGENTS.md                    # Agent 系统指令
├── MEMORY.md                    # Layer 2: 长期知识记忆
├── USER.md                      # 用户信息
├── README.md                    # 项目概述
├── progress.md                  # 开发进度
└── task_plan.md                 # 任务计划
```

---

## 📦 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **Agent 框架** | LangGraph | langchain.agents.create_agent (V2.0) |
| **LLM** | Claude 3.5 Sonnet | 中文理解强、长上下文、性价比高 |
| **输出管理** | Pipeline v2.1.0 | ToolExecutionResult + OutputLevel |
| **工具框架** | LangChain Core | StructuredTool |
| **向量数据库** | ChromaDB | 轻量级、易部署 |
| **关系数据库** | PostgreSQL | 成熟可靠、支持 JSON |
| **全文搜索** | SQLite FTS5 | 本地索引、BM25 算法 |
| **容器隔离** | Docker | 本地隔离环境 |
| **MCP 集成** | Z.ai (智谱) | Web 搜索 + Web 读取 |

---

## 📁 文件系统架构

### 文件系统设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          BA-Agent 文件系统                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        FileStore (统一管理层)                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │ │
│  │  │ArtifactStore │  │ UploadStore  │  │ ReportStore  │  │ ChartStore   │  │ │
│  │  │(工具结果)   │  │(用户上传)   │  │(报告文件)   │  │(图表文件)   │  │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │ │
│  │  ┌──────────────┐  ┌──────────────────────────────────────────────┐  │ │
│  │  │CacheStore   │  │ TempStore                                  │  │ │
│  │  │(缓存文件)   │  │(临时文件)                                 │  │ │
│  │  └──────────────┘  └──────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────────────────┐  │ │
│  │  │              MemoryStore (记忆存储)                           │  │ │
│  │  │  • write_memory()           # 写入记忆                             │  │ │
│  │  │  • get_memory()             # 读取记忆                             │  │ │
│  │  │  • search()                  # 搜索记忆                             │  │ │
│  │  │  • 支持 file_refs 参数       # 文件引用                             │  │ │
│  │  └──────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        物理存储层                                     │ │
│  │  /var/lib/ba-agent/                                                    │ │
│  │  ├── artifacts/           # 工具执行结果 (JSON)                        │ │
│  │  ├── uploads/             # 用户上传文件 (Excel/CSV)                     │ │
│  │  ├── reports/             # 生成的报告 (PDF/Word/Excel)                 │ │
│  │  ├── charts/              # 可视化图表 (PNG/HTML/SVG)                   │ │
│  │  ├── cache/               # 缓存文件 (JSON)                             │ │
│  │  ├── temp/                # 临时文件                                     │ │
│  │  ├── memory/              # 记忆文件 (Markdown)                           │ │
│  │  ├── checkpoints/         # 检查点和中间结果                            │ │
│  │  └── filestore.db         # 全局文件索引 (SQLite)                   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 存储目录结构

```
/var/lib/ba-agent/
├── artifacts/                           # 工具执行结果
│   ├── artifact_*.json
│   └── metadata.json
│
├── uploads/                             # 用户上传文件
│   └── {session_id}/
│       ├── {file_id}_original.xlsx
│       ├── {file_id}_parsed.json
│       └── {file_id}_preview.json
│
├── reports/                             # 生成的报告
│   └── {report_id}/
│       ├── report.pdf
│       ├── report.docx
│       ├── report.xlsx
│       └── metadata.json
│
├── charts/                              # 可视化图表
│   ├── {chart_id}.png
│   ├── {chart_id}.html
│   └── charts_index.db
│
├── cache/                               # 缓存文件
│   ├── idempotency/
│   └── semantic/
│
├── temp/                                # 临时文件
│   └── {session_id}/
│
├── checkpoints/                         # 检查点和中间结果
│   └── {session_id}/
│       ├── checkpoint_*.json
│       ├── df_*.parquet
│       └── chart_*.png
│
├── memory/                              # 记忆文件
│   ├── daily/                         # 每日日志
│   │   └── YYYY-MM-DD.md
│   ├── context/                       # 上下文文件
│   │   ├── CLAUDE.md
│   │   ├── MEMORY.md
│   │   └── USER.md
│   └── knowledge/                     # 知识库
│       ├── world/
│       ├── experience/
│       └── opinions/
│
└── filestore.db                         # 全局文件索引
```

### 文件引用系统

#### FileRef 统一引用

```python
class FileRef:
    """统一文件引用"""
    file_id: str                 # 唯一 ID
    category: FileCategory         # 文件类别
    session_id: Optional[str]      # 所属会话
    size_bytes: int               # 文件大小
    hash: str                     # 内容哈希
    mime_type: str                # MIME 类型
    metadata: dict                # 扩展元数据

    def __str__(self) -> str:
        return f"{self.category.value}:{self.file_id}"
```

#### 记忆文件引用

```markdown
# 记忆内容示例 (2026-02-06.md)

## 业务分析

用户分析了 Q1 销售数据，发现 GMV 增长 15%。

**关联文件**:
- 数据: `artifact:abc123`  # 原始数据
- 图表: `chart:def456`     # 趋势图
- 报告: `report:789xyz`   # 完整报告
```

#### 中间结果存储

```python
# Python 代码中的检查点
import pandas as pd

# 步骤 1
df = pd.read_csv('sales.csv')
checkpoint('step1_loaded')  # ← 创建检查点

# 步骤 2
df_clean = df.dropna()
save_df(df_clean, 'cleaned')  # ← 保存 DataFrame

# 步骤 3
result = analyze(df_clean)
checkpoint('step3_analyzed')
```

---

## 📝 结构化响应格式

### 响应格式定义

BA-Agent 使用统一的结构化 JSON 格式进行响应，支持工具调用和最终报告两种模式：

```json
{
    "task_analysis": "思维链：1. 识别意图; 2. 预判数据风险; 3. 设计复合指令",
    "execution_plan": "R1: [步骤描述]; R2: [步骤描述]",
    "current_round": 1,
    "action": {
        "type": "tool_call | complete",
        "content": "工具调用数组 或 最终报告字符串",
        "recommended_questions": ["推荐问题1", "推荐问题2"],
        "download_links": ["文件名.xlsx"]
    }
}
```

### Action Type 说明

| Type | 用途 | Content 格式 | 后续行为 |
|------|------|--------------|----------|
| `tool_call` | 需要调用工具 | 数组: `[{"tool_name": "...", "tool_call_id": "...", "arguments": {...}}]` | 执行工具后继续 |
| `complete` | 完成并返回报告 | 字符串: 包含分析结果、HTML 图表、代码等 | 结束，返回用户 |

### 响应示例

**工具调用响应**:
```json
{
    "task_analysis": "用户请求分析销售数据异动。需要查询数据库获取历史数据。",
    "execution_plan": "R1: 查询历史销售数据并计算增长率；R2: 生成可视化报告",
    "current_round": 1,
    "action": {
        "type": "tool_call",
        "content": [
            {
                "tool_name": "query_database",
                "tool_call_id": "call_qry_001",
                "arguments": {"sql": "SELECT quarter, amount FROM sales ORDER BY quarter"}
            }
        ]
    }
}
```

**完成报告响应**:
```json
{
    "task_analysis": "数据分析完成。Q3销售额增长最快，华东地区贡献显著。",
    "execution_plan": "R1: 数据处理; R2: 报告生成(当前)",
    "current_round": 2,
    "action": {
        "type": "complete",
        "content": "销售数据分析完成：\\n\\n1. Q1销售额500万，同比增长15%\\n2. Q3增长最快\\n\\n<div class='chart-wrapper'><div id='chart-trend'></div></div><script>...</script>",
        "recommended_questions": ["Q3增长原因？", "地区分布如何？"],
        "download_links": ["analysis_result.xlsx"]
    }
}
```

### 前端渲染

响应在前端的渲染包括：

1. **思维链分析** - 可折叠显示的分析过程
2. **执行计划** - 显示各轮次目标
3. **最终报告** - 支持纯文本、HTML（ECharts 图表）、代码块
4. **推荐问题** - 可点击的后续问题按钮
5. **下载链接** - 结果文件下载入口

---

## 🔐 安全与隐私

### 安全保障

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全保障                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  🔒 代码执行隔离          Docker 沙盒环境，防止恶意代码执行                  │
│  🔒 路径访问控制          文件操作白名单限制                                 │
│  🔒 数据只读访问          不修改业务数据，仅读取分析                          │
│  🔒 会话隔离              每个用户会话数据独立                                │
│  🔒 私有化部署            支持本地/私有云部署                                 │
│  🔒 文件引用安全          FileRef 抽象，不暴露真实路径                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 支持的部署方式

| 部署方式 | 适用场景 | 数据位置 |
|----------|----------|----------|
| **本地部署** | 个人/小团队使用 | 本地机器 |
| **私有云部署** | 企业内部使用 | 企业内网 |
| **专有云部署** | 大型企业/合规要求 | 专属云环境 |

---

## 📊 开发状态

### 开发进度

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总体进度: ████████████████████░░░░░░░░░░░░░░░░░░  70% (19/27 完成)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

阶段一: 基础框架        ████████████████████████████████  100% ✅
├─ Agent 框架 (LangGraph V2.0迁移)
├─ 9个核心工具
├─ Pipeline v2.1.0
├─ Memory 系统
└─ Hooks 系统

阶段二: Skills 系统     ████████████████████░░░░░░░░░░░░░░  75%
├─ Skills 框架          ████████████████████████████████  100% ✅
├─ 异动检测             ████████████████████░░░░░░░░░░░░░░   框架完成
├─ 归因分析             ████████████████████░░░░░░░░░░░░░░   框架完成
├─ 报告生成             ████████████████████░░░░░░░░░░░░░░   框架完成
└─ 数据可视化           ████████████████████░░░░░░░░░░░░░░   框架完成

阶段三: 文件系统        ████░░░░░░░░░░░░░░░░░░░░░░░░░░░   20%
├─ FileStore 框架        ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
├─ ArtifactStore         ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
├─ UploadStore           ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
├─ MemoryStore           ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
└─ CheckpointStore       ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中

阶段四: 服务集成        ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░   15%
├─ FastAPI 服务         ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
├─ Excel 上传流程       ░░░░░░░░░░░░░░░░░░░░░░░░░░░░   设计完成
└─ IM Bot 集成          ░░░░░░░░░░░░░░░░░░░░░░░░░░░   规划中
```

### 测试状态

```
总计: 746 个测试
✅ 通过: 746 (100%)
⏭️  跳过: 1 (MCP 相关)
❌ 失败: 0

┌─────────────────────────────────────────────────────────────────────────────┐
│ 测试分类                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ 基础设施    135  ████████████████████████████████  ✅                      │
│ 核心工具    303  ████████████████████████████████████████████  ✅                      │
│ Skills系统  137  ████████████████████████████████████  ✅                      │
│ Pipeline v2.1  42   ████████████  ✅                                                 │
│ Memory 系统  120  ████████████████████████████████  ✅                      │
│ Agent 集成   100  ████████████████████  ✅                                           │
│ MCP 集成      9   ███  ✅                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🗺️ 产品路线图

### 已完成 ✅ (2025 Q4 - 2026 Q1)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Phase 1: 基础框架                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ ✅ Agent 框架               LangGraph + Claude Sonnet 4.5                   │
│ ✅ 核心工具集               9个工具 (367个测试通过)                          │
│ ✅ Pipeline v2.1.0          统一工具输出格式系统                             │
│ ✅ Memory 系统              三层记忆 + 混合搜索                              │
│ ✅ Skills 框架              可配置技能系统                                    │
│ ✅ LangGraph API 迁移      迁移到 langchain.agents.create_agent             │
│ ✅ 工具集成修复              默认工具加载 + 记忆搜索工具                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 进行中 🚧 (2026 Q1-Q2)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Phase 2: 核心功能实现                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ ⏳ 文件系统框架              FileStore + 各类 Store 实现                        │
│ ⏳ 中间结果存储              CheckpointStore + PythonSandbox 增强                │
│ ⏳ Excel 上传流程              FastAPI + UploadStore 实现                          │
│ ⏳ 异动检测逻辑             统计检测 + AI分析                                   │
│ ⏳ 归因分析逻辑             维度下钻 + 事件关联                                  │
│ ⏳ 报告生成逻辑             模板化 + 智能洞察                                    │
│ ⏳ 数据可视化逻辑           图表推荐 + 自然语言生成                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 规划中 📋 (2026 Q2-Q4)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 3: 渠道集成                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ 📋 企业微信 Bot            对话式数据分析                                    │
│ 📋 钉钉 Bot                 对话式数据分析                                    │
│ 📋 Excel 插件              Office.js 侧边栏，结果写入表格                    │
│ 📋 Web 界面                可视化操作界面                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 4: 高级功能                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ 📋 预测分析                时间序列预测                                          │
│ 📋 自定义仪表盘            拖拽式报表配置                                    │
│ 📋 移动端支持              H5/小程序                                             │
│ 📋 行业模板库              零售/电商/SaaS等行业模板                          │
│ 📋 API 开放平台            第三方集成                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📈 成功指标

### 产品指标

| 指标 | 目标 | 测量方式 | 当前状态 |
|------|------|----------|----------|
| **日活跃用户** | MVP上线1个月内达到100+ | 登录用户数 | - |
| **查询成功率** | >90% | 成功响应/总查询 | ✅ 测试覆盖率 100% |
| **平均响应时间** | <5秒 | 端到端响应时间 | ✅ 本地测试 <2s |
| **用户满意度** | >4.0/5.0 | 用户评分 | - |
| **周留存率** | >60% | 7日内回访用户占比 | - |

### 业务价值指标

| 指标 | 目标 | 预期效果 |
|------|------|----------|
| **节省时间** | 相比传统方式节省70% | 从小时级→分钟级 |
| **数据洞察准确率** | >85% | AI分析准确度 |
| **报告生成效率** | 从小时级到分钟级 | 2-4小时→5分钟 |
| **数据团队响应** | 减少简单查询需求50% | 释放数据团队精力 |

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `docs/implementation.md` | 具体执行计划（开发技术方案） |
| `README.md` | 项目介绍和快速开始 |
| `task_plan.md` | 开发任务计划 |
| `progress.md` | 开发进度详情 |

---

**文档版本**: v2.1.0
**最后更新**: 2026-02-07
**维护者**: BA-Agent Development Team
**测试状态**: 746/746 通过 (100%)
