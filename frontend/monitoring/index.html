<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BA-Agent 监控仪表板</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Mermaid.js for flowchart rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- ECharts for metrics visualization -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="monitor-header">
        <div class="header-content">
            <h1>📊 BA-Agent 监控仪表板</h1>
            <div class="user-info">
                <span id="user-display"></span>
                <button class="btn btn-secondary" onclick="logout()">登出</button>
                <a href="/" class="btn btn-secondary">返回对话</a>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="monitor-layout">
        <!-- Left Sidebar: Conversation List -->
        <aside class="conversation-sidebar">
            <div class="sidebar-header">
                <h2>对话列表</h2>
                <button class="btn-icon" onclick="refreshConversations()" title="刷新">🔄</button>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>时间范围</label>
                    <select id="time-filter" onchange="filterConversations()">
                        <option value="today">今日</option>
                        <option value="week" selected>本周</option>
                        <option value="month">本月</option>
                        <option value="all">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>状态筛选</label>
                    <select id="status-filter" onchange="filterConversations()">
                        <option value="all">全部</option>
                        <option value="success">成功</option>
                        <option value="error">错误</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="search-input" placeholder="搜索对话ID..." onkeyup="filterConversations()">
                </div>
            </div>

            <!-- Conversation List -->
            <div class="conversation-list" id="conversation-list">
                <div class="loading">加载中...</div>
            </div>
        </aside>

        <!-- Main Content: Trace Details -->
        <main class="trace-content">
            <div id="trace-empty" class="empty-state">
                <div class="empty-icon">📋</div>
                <h3>选择一个对话查看详情</h3>
                <p>从左侧列表中选择一个对话来查看执行追踪</p>
            </div>

            <div id="trace-details" class="trace-details" style="display: none;">
                <!-- Trace Header -->
                <div class="trace-header">
                    <div class="trace-info">
                        <h2 id="trace-conversation-id">conversation_id</h2>
                        <div class="trace-meta">
                            <span id="trace-session-id">Session: -</span>
                            <span id="trace-duration">Duration: -</span>
                            <span id="trace-status">Status: -</span>
                        </div>
                    </div>
                    <div class="trace-actions">
                        <button class="btn btn-secondary" onclick="exportTrace('json')">📥 JSON</button>
                        <button class="btn btn-secondary" onclick="exportTrace('mermaid')">📊 Mermaid</button>
                    </div>
                </div>

                <!-- Mermaid Flowchart -->
                <div class="flowchart-section">
                    <h3>执行流程</h3>
                    <div class="flowchart-container" id="flowchart-container">
                        <div id="flowchart" class="mermaid"></div>
                    </div>
                </div>

                <!-- Span Details Table -->
                <div class="spans-section">
                    <h3>执行步骤</h3>
                    <div class="spans-table-wrapper">
                        <table class="spans-table" id="spans-table">
                            <thead>
                                <tr>
                                    <th>类型</th>
                                    <th>名称</th>
                                    <th>耗时</th>
                                    <th>状态</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody id="spans-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar: Metrics Dashboard -->
        <aside class="metrics-sidebar">
            <div class="metrics-header">
                <h2>性能指标</h2>
            </div>

            <!-- Summary Cards -->
            <div class="metrics-summary">
                <div class="metric-card">
                    <div class="metric-label">总耗时</div>
                    <div class="metric-value" id="metric-duration">-</div>
                    <div class="metric-unit">ms</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Token 总数</div>
                    <div class="metric-value" id="metric-tokens">-</div>
                    <div class="metric-unit">tokens</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">预估成本</div>
                    <div class="metric-value" id="metric-cost">-</div>
                    <div class="metric-unit">USD</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">工具调用</div>
                    <div class="metric-value" id="metric-tools">-</div>
                    <div class="metric-unit">calls</div>
                </div>
            </div>

            <!-- Token Breakdown Chart -->
            <div class="chart-section">
                <h3>Token 分布</h3>
                <div id="token-chart" class="chart-container"></div>
            </div>

            <!-- Duration Breakdown Chart -->
            <div class="chart-section">
                <h3>耗时分布</h3>
                <div id="duration-chart" class="chart-container"></div>
            </div>

            <!-- Tool Statistics -->
            <div class="chart-section">
                <h3>工具调用统计</h3>
                <div id="tools-chart" class="chart-container"></div>
            </div>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/conversation-list.js"></script>
    <script src="js/trace-viewer.js"></script>
    <script src="js/metrics-dashboard.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
