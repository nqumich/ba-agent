# BA-Agent Progress Log

Started: 2025-02-04

## Codebase Patterns
- 项目结构：backend/ (核心代码), config/ (配置), skills/ (可配置Skills), docs/ (文档)
- 所有工具继承自 `langchain_core.tools.StructuredTool` (注意：不是 langchain.tools)
- Agent创建使用 `langgraph.prebuilt.create_react_agent` (LangChain 1.2.x 推荐方式)
- 所有Skills通过 `config/skills.yaml` 注册
- 使用 Pydantic 定义所有数据模型
- Docker隔离用于代码执行
- 本地隔离环境替代云端虚拟机

## MCP Tools (已配置)
- `mcp__web-search-prime__webSearchPrime`: Web搜索功能
- `mcp__web_reader__webReader`: 网页内容提取功能

## Supported AI Models
- Claude (Anthropic): anthropic>=0.40.0
- OpenAI (GPT): openai>=1.0.0
- Google Gemini: google-genai>=1.0.0
- 智谱 AI (GLM-4.7): zhipuai>=2.0.0

## Key Files
- backend/agents/agent.py (主Agent)
- backend/tools/ (基础工具)
- skills/ (可配置分析Skills)
- config/skills.yaml (Skills配置)

---

## [2025-02-04] - 渐进式工具使用系统实现
- **任务**: 实现 BA-Agent 渐进式工具使用系统
- **文件变更**:
  - 新增: backend/orchestration/tool_orchestrator.py (工具编排器)
  - 新增: backend/orchestration/focus_manager.py (焦点管理器)
  - 新增: backend/hooks/hook_manager.py (Hooks管理器)
  - 新增: config/tools.yaml (工具配置)
  - 新增: .claude/hooks.json (Hooks配置)
  - 新增: .claude/hooks/*.sh (Hook脚本)
  - 更新: scripts/ralph/prompt.md (添加渐进式工具使用说明)
  - 更新: scripts/ralph/prd.json (添加渐进式工具使用任务)
- **完成标准**:
  - ✅ Tool Orchestrator - 状态机工具选择
  - ✅ Focus Manager - 定期重新聚焦 (每5步)
  - ✅ Hooks Manager - PreToolUse, PostToolUse, Stop 事件
  - ✅ 工具分组 (query_*, exec_*, skill_*, memory_*)
  - ✅ 状态转换 (idle → query → analyzing → reporting → done)
  - ✅ Hook脚本示例 (check-permissions, update-progress, check-completion)
- **Learnings**:
  - Clawdbot 的工具掩码策略 (按前缀分组，KV-cache 友好)
  - Manus AI 的注意力操控 (定期重读计划避免目标漂移)
  - Hooks 系统 (中间件模式，可阻止/修改操作)
  - 状态机工具选择 (动态控制工具可见性)
  - 上下文压缩和恢复 (保留 URL/路径，压缩长内容)

---

## [2025-02-04] - 三层记忆管理系统实现
- **任务**: 实现 BA-Agent 三层记忆管理系统
- **文件变更**:
  - 新增: CLAUDE.md, AGENTS.md, USER.md, MEMORY.md
  - 新增: memory/2025-02-04.md
  - 新增: task_plan.md, findings.md, progress.md (Manus 三文件模式)
  - 更新: .gitignore (忽略本地记忆文件)
  - 更新: scripts/ralph/prd.json (添加记忆管理任务)
- **完成标准**:
  - ✅ 创建三层记忆文件结构
  - ✅ CLAUDE.md - 项目级记忆 (团队共享)
  - ✅ AGENTS.md - Agent 系统指令和记忆指南
  - ✅ USER.md - 用户信息和偏好
  - ✅ MEMORY.md - 长期策划知识
  - ✅ memory/YYYY-MM-DD.md - 每日日志
  - ✅ task_plan.md - 任务进度跟踪
  - ✅ findings.md - 研究发现
  - ✅ progress.md - 会话日志
- **Learnings**:
  - Clawdbot/Moltbot 的三层 Markdown 记忆架构
  - Progressive Context Generation (渐进式解析)
  - Manus AI 的三文件模式 (task_plan.md, findings.md, progress.md)
  - Context vs Memory: 临时上下文 vs 持久存储
  - 搜索胜过注入: 不将所有记忆塞入上下文，而是按需搜索
  - 混合搜索: 向量搜索 (0.7) + 关键词搜索 (0.3)

---

## [2025-02-04] - LangChain 1.2.x API 修复完成
- **任务**: 修复 LangChain 1.2.x API 兼容性问题
- **文件变更**: requirements.txt, scripts/ralph/prd.json, scripts/ralph/prompt.md
- **完成标准**:
  - ✅ 安装 langchain>=0.3.0, langgraph>=0.2.0, langchain-anthropic>=0.2.0
  - ✅ 更新 US-004 使用 langchain.agents.create_agent (新推荐方式)
  - ✅ 更新所有工具的 US-006~US-013 使用 langchain_core.tools.StructuredTool
  - ✅ 更新 prompt.md 添加正确的 LangChain 1.2.8+ API 示例
  - ✅ 验证所有 API 导入和创建正常工作
- **Learnings**:
  - LangChain 1.2.x 弃用了 langchain.agents.AgentExecutor
  - 新推荐方式: `langchain.agents.create_agent`
  - 备选方式: `langgraph.prebuilt.create_react_agent` (有弃用警告但仍可用)
  - StructuredTool 从 langchain.tools 移至 langchain_core.tools
  - 需要使用 MemorySaver checkpointer 支持对话历史
  - 必须安装完整的 langchain 包 (不只是 langchain-core)

---

## [2025-02-04] - 依赖安装完成
- **任务**: 安装所有Python依赖
- **文件变更**: requirements.txt, .env.example
- **完成标准**:
  - ✅ 核心框架: langchain, anthropic, fastapi
  - ✅ AI模型: Claude, OpenAI, Gemini, GLM-4.7 (zhipuai)
  - ✅ 数据分析: pandas, numpy, scipy
  - ✅ 科学统计: statsmodels, scikit-learn, sympy, patsy
  - ✅ Excel处理: openpyxl, xlrd, xlwt, xlsxwriter
  - ✅ 可视化: plotly, matplotlib, kaleido
  - ✅ 报告生成: python-docx, reportlab
- **Learnings**:
  - 使用清华 PyPI 镜像源加速安装
  - google-genai (新SDK) 替代已弃用的 google-generativeai
  - Python 3.14 ARM64 暂不支持 chromadb (缺少 onnxruntime)

---
